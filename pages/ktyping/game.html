<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KrazyType ‚Äî KrazyPlace</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">

  <style>
    html, body {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
    }

    main { flex: 1; }

    .container-narrow {
      max-width: 900px;
      margin: auto;
    }

    .game-box {
      background: var(--surface-2);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin-top: 1rem;
    }

    textarea {
      font-family: monospace;
      resize: vertical;
    }

    .rules span {
      display: inline-block;
      margin-right: 1rem;
      font-weight: bold;
    }

    .timer {
      font-size: 1.2rem;
      font-weight: bold;
    }

    footer {
      text-align: center;
      border-top: 1px solid var(--surface-3);
      padding: 1rem;
    }
  </style>
</head>

<body>
<header class="container container-narrow">
  <nav>
    <ul>
      <li><a href="#">KrazyPlace</a></li>
      <li>K Typing</li>
    </ul>
  </nav>
</header>

<main class="container container-narrow">
  <section>
    <h1>KrazyType</h1>
    <p>R√©√©cris le texte‚Ä¶ puis valide quand tu penses avoir fini.</p>

    <div style="margin:1rem 0">
      <button id="dailyBtn">Partie du jour üåû</button>
      <button id="randomBtn">Partie al√©atoire üé≤</button>
    </div>

    <div id="game" class="game-box" style="display:none">
      <p class="timer">‚è±Ô∏è Temps : <span id="time">0.00</span>s</p>

      <h4>Texte √† r√©√©crire</h4>
      <blockquote id="targetText"></blockquote>

      <div class="rules">
        <span id="bannedRule"></span>
        <span id="swapRule"></span>
      </div>

      <textarea id="input" rows="5" placeholder="Tape ici‚Ä¶"></textarea>
      <button id="submitBtn">‚úÖ Valider</button>

      <p id="status"></p>
    </div>

    <div id="end" class="game-box" style="display:none">
      <h2>üéâ Termin√© !</h2>
      <p>Temps : <strong><span id="finalTime"></span>s</strong></p>
      <p>Erreurs : <strong><span id="finalErrors"></span></strong></p>
      <p>Score : <strong><span id="finalScore"></span></strong></p>
    </div>
  </section>
</main>

<footer>¬© KrazyPlace</footer>

<script>
/* ================= RNG ================= */
function pseudoRandom(seed) {
  let s = seed;
  return () => {
    s = (s * 16807) % 2147483647;
    return (s - 1) / 2147483646;
  };
}

/* ============ TEXTE ============ */
function generateText(rng) {
  const texts = [
    "Le clavier devient un pi√®ge pour le joueur rapide",
    "Ce jeu modifie les lettres et perturbe la frappe",
    "La logique d√©fie le cerveau et les doigts",
    "Le code transforme une phrase simple en d√©fi"
  ];
  return texts[Math.floor(rng() * texts.length)] + ".";
}

/* ============ UTILITAIRES ============ */
function lettersInText(text) {
  return [...new Set(text.toLowerCase().match(/[a-z]/g))];
}

function pickRandom(rng, arr) {
  return arr[Math.floor(rng() * arr.length)];
}

/* ============ R√àGLES BAS√âES SUR LE TEXTE ============ */
function generateRulesFromText(rng, text) {
  const letters = lettersInText(text);

  const frequency = {};
  for (const c of text.toLowerCase()) {
    if (c >= "a" && c <= "z") {
      frequency[c] = (frequency[c] || 0) + 1;
    }
  }

  const bannable = letters.filter(l => frequency[l] >= 2);
  const banned = pickRandom(rng, bannable);

  const swappable = letters.filter(l => l !== banned);
  const l1 = pickRandom(rng, swappable);
  let l2;
  do {
    l2 = pickRandom(rng, swappable);
  } while (l2 === l1);

  return {
    bannedLetters: [banned],
    swap: { [l1]: l2, [l2]: l1 }
  };
}

/* ============ √âTAT ============ */
let rng;
let bannedLetters = [];
let swap = {};
let startTime;
let timerInterval;
let errorCount = 0;

/* ============ JEU ============ */
function startGame(seed) {
  rng = pseudoRandom(seed);
  errorCount = 0;

  const text = generateText(rng);
  document.getElementById("targetText").textContent = text;

  const rules = generateRulesFromText(rng, text);
  bannedLetters = rules.bannedLetters;
  swap = rules.swap;

  const [l1, l2] = Object.keys(swap);

  document.getElementById("bannedRule").textContent =
    "üö´ Lettre interdite : " + bannedLetters[0];

  document.getElementById("swapRule").textContent =
    `üîÑ Lettres invers√©es : ${l1} ‚Üî ${l2}`;

  document.getElementById("game").style.display = "block";
  document.getElementById("end").style.display = "none";
  document.getElementById("status").textContent = "";

  const input = document.getElementById("input");
  input.value = "";
  input.disabled = false;
  input.focus();

  startTime = performance.now();
  timerInterval = setInterval(updateTimer, 50);
}

function updateTimer() {
  document.getElementById("time").textContent =
    ((performance.now() - startTime) / 1000).toFixed(2);
}

/* ============ VALIDATION ============ */
document.getElementById("submitBtn").onclick = () => {
  const input = document.getElementById("input").value;
  const target = document.getElementById("targetText").textContent;

  if (input.length !== target.length) {
    document.getElementById("status").textContent =
      "‚ùå Longueur incorrecte";
    return;
  }

  errorCount = 0;

  for (let i = 0; i < target.length; i++) {
    let expected = target[i].toLowerCase();

    if (bannedLetters.includes(expected)) {
      expected = "*";
    } else if (swap[expected]) {
      expected = swap[expected];
    }

    if (input[i].toLowerCase() !== expected) {
      errorCount++;
    }
  }

  endGame();
};

function endGame() {
  clearInterval(timerInterval);

  const time = (performance.now() - startTime) / 1000;
  const score = Math.max(
    0,
    Math.floor(10000 - (time * 100) - (errorCount * 500))
  );

  document.getElementById("game").style.display = "none";
  document.getElementById("end").style.display = "block";

  document.getElementById("finalTime").textContent = time.toFixed(2);
  document.getElementById("finalErrors").textContent = errorCount;
  document.getElementById("finalScore").textContent = score;
}

/* ============ MODES ============ */
document.getElementById("dailyBtn").onclick = () => {
  const today = new Date().toISOString().split("T")[0];
  const seed = [...today].reduce((a, c) => a + c.charCodeAt(0), 0);
  startGame(seed);
};

document.getElementById("randomBtn").onclick = () => {
  startGame(Math.floor(Math.random() * 2147483647));
};
</script>
</body>
</html>
